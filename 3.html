<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¡”ç½—ç‰Œæ´—ç‰Œ</title>
<style>
    /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ï¼Œåªæ·»åŠ æ–°æ ·å¼ */
    
    /* å åœæŒ‰é’®æ ·å¼ */
    #startDivinationBtn {
        background: linear-gradient(45deg,rgba(0,255,0,0.3),rgba(0,255,0,0.1));
        border: 2px solid #00ff00;
        color: #00ff00;
    }
    
    /* è§£è¯»å¼¹çª—æ ·å¼ */
    .interpretation-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    }
    
    .modal-content {
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        padding: 30px;
        border-radius: 15px;
        border: 2px solid #ffd700;
        max-width: 500px;
        width: 90%;
        color: #fff;
        position: relative;
    }
    
    .close-modal {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
        color: #ffd700;
    }
    
    .card-position {
        color: #ffd700;
        margin-bottom: 10px;
        font-weight: bold;
    }
	
	 * { margin:0; padding:0; box-sizing:border-box; }
    body {
        font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #0a0a1a, #050510, #020208);
        color:#e6e6e6;
        min-height:100vh;
        display:flex;
        flex-direction:column;
        align-items:center;
        padding:20px;
        position:relative;
        overflow-x:hidden;
    }
    
    html, body {
        background: #020208;
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
    }
    
    .container { 
        max-width:1200px; 
        width:100%; 
        margin:0 auto;
        position:relative;
        z-index:1;
    }
    
    .animation-container {
        position:relative; 
        width:100%; 
        height:70vh;
        overflow:hidden; 
        margin:25px 0;
        background: transparent;
    }
    
    /* å¡”ç½—ç‰Œç¬¦å·èƒŒæ™¯å…ƒç´  - æ”¾åœ¨æœ€åº•å±‚ */
    .tarot-symbol {
        position: absolute;
        font-size: 3rem;
        color: rgba(255,215,0,0.1);
        animation: symbolFloat 8s ease-in-out infinite;
        pointer-events: none;
        z-index: 1; /* é™ä½å±‚çº§ */
    }
    
    @keyframes symbolFloat {
        0%, 100% { 
            transform: translate(0, 0) rotate(0deg);
            opacity: 0.1;
        }
        25% { 
            transform: translate(20px, -15px) rotate(90deg);
            opacity: 0.3;
        }
        50% { 
            transform: translate(-15px, 20px) rotate(180deg);
            opacity: 0.1;
        }
        75% { 
            transform: translate(15px, 15px) rotate(270deg);
            opacity: 0.2;
        }
    }
    
    /* å¢å¤§ç‰Œçš„å¤§å° */
    .card {
        position:absolute; 
        width:140px;
        height:220px;
        border-radius:12px;
        box-shadow:0 8px 25px rgba(0,0,0,0.8);
        transition:all 0.8s cubic-bezier(0.25,0.46,0.45,0.94);
        transform-style: preserve-3d; 
        cursor:pointer;
        z-index: 20; /* æé«˜ç‰Œçš„å±‚çº§ */
    }
    
    .card-front,.card-back{
        position:absolute;
        width:100%;
        height:100%;
        backface-visibility:hidden;
        border-radius:12px; 
        display:flex; 
        align-items:center; 
        justify-content:center;
        flex-direction:column; 
        padding:15px;
        overflow: hidden;
    }
    
    .card-front { 
        background:linear-gradient(135deg,#f8f8f8,#e8e8e8); 
        color:#333; 
        transform:rotateY(180deg);
    }
    
    .card-back { 
        background:linear-gradient(45deg,#8b0000,#4b0082,#8b0000); 
        color:#ffd700; 
        border:3px solid #ffd700;
    }
    
    .card.flipped{ 
        transform:rotateY(180deg);
        box-shadow:0 12px 35px rgba(0,0,0,0.8),
                  0 0 20px rgba(255,215,0,0.6);
        z-index: 1000 !important; /* ç¡®ä¿ç¿»è½¬çš„ç‰Œåœ¨æœ€ä¸Šé¢ */
    }
    
    .card-symbol{ 
        font-size:2.8rem;
        margin:10px 0;
    }
    
    .card-name{ 
        font-size:1.1rem;
        font-weight:bold; 
        text-align:center;
    }
    
    .mystic-symbol{ 
        font-size:3rem;
        margin-bottom:10px;
        color:#ffd700;
    }
    
    .controls{ 
        display:flex; 
        justify-content:center; 
        gap:20px; 
        margin-bottom:25px; 
        flex-wrap:wrap; 
    }
    
    .btn{
        padding:12px 25px; 
        background:linear-gradient(45deg,rgba(255,215,0,0.3),rgba(255,215,0,0.1));
        color:#ffd700; 
        border:2px solid #ffd700;
        border-radius:50px; 
        cursor:pointer; 
        font-weight:bold; 
        transition:all 0.4s ease;
        backdrop-filter:blur(10px);
        text-shadow:0 0 10px rgba(255,215,0,0.5);
        box-shadow:0 5px 15px rgba(255,215,0,0.3);
    }
    
    .btn:hover{ 
        background:linear-gradient(45deg,rgba(255,215,0,0.5),rgba(255,215,0,0.2));
        transform:translateY(-3px);
        box-shadow:0 8px 25px rgba(255,215,0,0.5);
    }
    
    .btn:disabled{ 
        opacity:0.5; 
        cursor:not-allowed; 
        transform:none;
    }
    
    .status{ 
        text-align:center; 
        margin:15px 0; 
        color:#ffd700; 
        min-height:25px;
        font-size:1.2rem;
        text-shadow:0 0 15px rgba(255,215,0,0.7);
    }

    /* å¹³é“ºæ»šåŠ¨ */
    .card-track{
        display:flex; 
        height:100%; 
        position:absolute; 
        left:0;
        top: 50%;
        transform: translateY(-50%);
        animation:scrollLeft 35s linear infinite;
        align-items: center;
        z-index: 15;
    }
    
    .track-card{ 
        flex:0 0 auto; 
        width:140px;
        height:220px;
        margin-right:-100px;
        border-radius:12px; 
        cursor:pointer; 
        transition:all 0.4s; 
        transform-style: preserve-3d; 
        position:relative;
        box-shadow:0 6px 20px rgba(0,0,0,0.7);
    }
    
    .track-card:hover{ 
        margin-right:-80px;
        transform:translateY(-8px) scale(1.05); 
        z-index:25;
        box-shadow:0 12px 35px rgba(0,0,0,0.8),
                  0 0 20px rgba(255,215,0,0.6);
    }

    .track-card.flipped{ 
        transform:rotateY(180deg) translateY(-8px) scale(1.05);
        z-index: 1000 !important; /* ç¡®ä¿ç¿»è½¬çš„ç‰Œåœ¨æœ€ä¸Šé¢ */
    }

    /* å›¾ç‰‡æ ·å¼ */
    .card-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 12px;
    }

    .back-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 12px;
    }

    /* ç²’å­æ•ˆæœ - æ”¾åœ¨ç‰Œçš„å‰é¢ */
    .particle {
        position: absolute;
        width: 12px;
        height: 12px;
        background: #ffd700;
        border-radius: 50%;
        pointer-events: none;
        box-shadow: 0 0 20px #ffd700;
        animation: particleFloat 2s ease-out forwards;
        z-index: 25;
    }
    
    /* å¤§ç²’å­æ•ˆæœ */
    .big-particle {
        position: absolute;
        width: 20px;
        height: 20px;
        background: radial-gradient(circle, #ffd700, #ffed4e);
        border-radius: 50%;
        pointer-events: none;
        box-shadow: 0 0 30px #ffd700, 0 0 60px rgba(255,215,0,0.5);
        animation: bigParticleFloat 1.5s ease-out forwards;
        z-index: 25;
    }
    
    @keyframes particleFloat {
        0% {
            opacity: 1;
            transform: translate(0, 0) scale(1);
        }
        100% {
            opacity: 0;
            transform: translate(var(--tx), var(--ty)) scale(0);
        }
    }
    
    @keyframes bigParticleFloat {
        0% {
            opacity: 1;
            transform: translate(0, 0) scale(1);
        }
        100% {
            opacity: 0;
            transform: translate(var(--tx), var(--ty)) scale(0);
        }
    }
    
    @keyframes scrollLeft{
        0%{ transform: translateY(-50%) translateX(0); }
        100%{ transform: translateY(-50%) translateX(-50%); }
    }
    
    /* ä»ªå¼ç¯å…‰æ•ˆæœ */
    .ritual-light {
        position:absolute;
        top:50%;
        left:50%;
        width:200px;
        height:200px;
        background:radial-gradient(circle, rgba(255,215,0,0.2) 0%, rgba(255,215,0,0) 70%);
        border-radius:50%;
        transform:translate(-50%,-50%);
        pointer-events:none;
        z-index: 5;
        animation:lightPulse 3s ease-in-out infinite;
        display: none;
    }
    
    @keyframes lightPulse {
        0%, 100% { opacity:0.3; transform:translate(-50%,-50%) scale(1); }
        50% { opacity:0.6; transform:translate(-50%,-50%) scale(1.2); }
    }
    
    /* èƒŒæ™¯é—ªçƒæ•ˆæœ */
    .bg-flash {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at center, rgba(255,215,0,0.15) 0%, transparent 70%);
        opacity: 0;
        pointer-events: none;
        z-index: 0;
        animation: bgFlash 4s ease-in-out infinite;
    }
    
    @keyframes bgFlash {
        0%, 100% { opacity: 0; }
        50% { opacity: 0.3; }
    }
    
    /* å¼ºçƒˆèƒŒæ™¯é—ªçƒæ•ˆæœ */
    .bg-flash-intense {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at center, rgba(255,215,0,0.3) 0%, transparent 70%);
        opacity: 0;
        pointer-events: none;
        z-index: 0;
        animation: bgFlashIntense 2s ease-in-out infinite;
    }
    
    @keyframes bgFlashIntense {
        0%, 100% { opacity: 0; }
        50% { opacity: 0.5; }
    }
<    /* å åœæŒ‰é’®æ ·å¼ */
    #startDivinationBtn {
        background: linear-gradient(45deg,rgba(0,255,0,0.3),rgba(0,255,0,0.1));
        border: 2px solid #00ff00;
        color: #00ff00;
    }
    
    /* ç§»é™¤å¼¹çª—ç›¸å…³æ ·å¼ */
</style>
</head>
<body>
    <!-- èƒŒæ™¯é—ªçƒæ•ˆæœ -->
    <div class="bg-flash"></div>
    <div class="bg-flash-intense" id="bgFlashIntense" style="display:none;"></div>

    <div class="container">
        <div class="status" id="statusMessage">ç‰Œå·²å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…æ´—ç‰Œå¼€å§‹...</div>

        <div class="animation-container" id="animationArea">
            <!-- å¡”ç½—ç‰Œç¬¦å·èƒŒæ™¯ - æ”¾åœ¨æœ€å‰é¢ -->
            <div id="tarotSymbolsContainer" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:1;"></div>
            <!-- ä»ªå¼ç¯å…‰ -->
            <div class="ritual-light" id="ritualLight"></div>
            <!-- ç²’å­å®¹å™¨ -->
            <div id="particlesContainer" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:30;"></div>
        </div>

        <div class="controls">
            <button class="btn" id="startShuffleBtn">å¼€å§‹æ´—ç‰Œ</button>
            <button class="btn" id="startDivinationBtn" style="display:none;">å¼€å§‹å åœ</button>
            <button class="btn" id="resetBtn" style="display:none;">é‡æ–°å¼€å§‹</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded',function(){
    const animationArea=document.getElementById('animationArea');
    const startShuffleBtn=document.getElementById('startShuffleBtn');
    const startDivinationBtn=document.getElementById('startDivinationBtn');
    const resetBtn=document.getElementById('resetBtn');
    const statusMessage=document.getElementById('statusMessage');
    
    let particlesContainer=document.getElementById('particlesContainer');
    let tarotSymbolsContainer = document.getElementById('tarotSymbolsContainer');
    let ritualLight=document.getElementById('ritualLight');
    const bgFlashIntense = document.getElementById('bgFlashIntense');

    // å¡”ç½—ç‰Œç¬¦å·
    const tarotSymbols = ["ğŸƒ", "ğŸª„", "ğŸŒ™", "ğŸ‘‘", "âš”ï¸", "ğŸ“–", "ğŸ’‘", "ğŸ›¡ï¸", "ğŸ¦", "ğŸ§™", "ğŸ”„", "âš–ï¸", "ğŸ™ƒ", "ğŸ’€", "ğŸ¥„", "ğŸ˜ˆ", "ğŸ°", "â­", "ğŸŒ•", "â˜€ï¸", "ğŸ‘¼", "ğŸŒ", "âœ¦", "â™ ï¸", "â™¥ï¸", "â™¦ï¸", "â™£ï¸"];

    // å¡”ç½—ç‰Œæ•°æ® - å°†ä»JSONæ–‡ä»¶åŠ è½½
    let tarotCards = [];
    let backImagePath = 'img/back.jpg';
    
    // å åœç›¸å…³å˜é‡
    let selectedCards = []; // é€‰ä¸­çš„ä¸‰å¼ ç‰Œ
    let flippedCount = 0; // å·²ç¿»è½¬çš„ç‰Œæ•°é‡
    const MAX_FLIPS = 3; // ä¸‰å¼ ç‰Œé˜µ

    // åŠ è½½å¡”ç½—ç‰Œæ•°æ®
    async function loadTarotData() {
        try {
            const response = await fetch('tarot-images.json');
            const data = await response.json();
            
            // è¿‡æ»¤å‡ºå¤§é˜¿å¡çº³ç‰Œ
            tarotCards = data.cards.filter(card => card.arcana === "Major Arcana");
            
            // ç¡®ä¿å›¾ç‰‡è·¯å¾„æ­£ç¡®
            tarotCards.forEach(card => {
                if (card.img) {
                    card.img = 'img/' + card.img;
                }
            });
            
            console.log('å¡”ç½—ç‰Œæ•°æ®åŠ è½½æˆåŠŸ:', tarotCards.length, 'å¼ ç‰Œ');
            initializeDeck();
        } catch (error) {
            console.error('åŠ è½½å¡”ç½—ç‰Œæ•°æ®å¤±è´¥:', error);
            // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
            tarotCards = [
                {name: "The Fool", number: "0", img: "img/m00.jpg"},
                {name: "The Magician", number: "1", img: "img/m01.jpg"},
                {name: "The High Priestess", number: "2", img: "img/m02.jpg"},
                {name: "The Empress", number: "3", img: "img/m03.jpg"},
                {name: "The Emperor", number: "4", img: "img/m04.jpg"},
                {name: "The Hierophant", number: "5", img: "img/m05.jpg"},
                {name: "The Lovers", number: "6", img: "img/m06.jpg"},
                {name: "The Chariot", number: "7", img: "img/m07.jpg"},
                {name: "Strength", number: "8", img: "img/m08.jpg"},
                {name: "The Hermit", number: "9", img: "img/m09.jpg"},
                {name: "Wheel of Fortune", number: "10", img: "img/m10.jpg"},
                {name: "Justice", number: "11", img: "img/m11.jpg"},
                {name: "The Hanged Man", number: "12", img: "img/m12.jpg"},
                {name: "Death", number: "13", img: "img/m13.jpg"},
                {name: "Temperance", number: "14", img: "img/m14.jpg"},
                {name: "The Devil", number: "15", img: "img/m15.jpg"},
                {name: "The Tower", number: "16", img: "img/m16.jpg"},
                {name: "The Star", number: "17", img: "img/m17.jpg"},
                {name: "The Moon", number: "18", img: "img/m18.jpg"},
                {name: "The Sun", number: "19", img: "img/m19.jpg"},
                {name: "Judgement", number: "20", img: "img/m20.jpg"},
                {name: "The World", number: "21", img: "img/m21.jpg"}
            ];
            initializeDeck();
        }
    }

    // åˆ›å»ºå¡”ç½—ç‰Œç¬¦å·èƒŒæ™¯
    function createTarotSymbols() {
        tarotSymbolsContainer.innerHTML = '';
        const areaWidth = animationArea.offsetWidth;
        const areaHeight = animationArea.offsetHeight;
        
        for(let i = 0; i < 15; i++) { // å‡å°‘ç¬¦å·æ•°é‡
            const symbol = document.createElement('div');
            symbol.className = 'tarot-symbol';
            symbol.textContent = tarotSymbols[Math.floor(Math.random() * tarotSymbols.length)];
            symbol.style.left = Math.random() * 100 + '%';
            symbol.style.top = Math.random() * 100 + '%';
            symbol.style.animationDelay = (Math.random() * 8) + 's';
            symbol.style.fontSize = (Math.random() * 1.5 + 1.5) + 'rem'; // å‡å°ç¬¦å·å¤§å°
            symbol.style.opacity = Math.random() * 0.15 + 0.05; // é™ä½é€æ˜åº¦
            tarotSymbolsContainer.appendChild(symbol);
        }
    }

    let cards=[],isAnimating=false;

    // ç²’å­æ•ˆæœå‡½æ•°
    function createParticles(x, y, count = 20, bigParticles = false) {
        for(let i = 0; i < count; i++) {
            const particle = document.createElement('div');
            particle.className = bigParticles && i % 3 === 0 ? 'big-particle' : 'particle';
            
            const angle = Math.random() * Math.PI * 2;
            const distance = 100 + Math.random() * 150;
            const tx = Math.cos(angle) * distance;
            const ty = Math.sin(angle) * distance;
            
            particle.style.left = x + 'px';
            particle.style.top = y + 'px';
            particle.style.setProperty('--tx', tx + 'px');
            particle.style.setProperty('--ty', ty + 'px');
            particle.style.animationDelay = (Math.random() * 0.8) + 's';
            
            particlesContainer.appendChild(particle);
            
            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 2500);
        }
    }

    // ä»ªå¼ç¯å…‰æ•ˆæœ
    function startRitualFocus() {
        ritualLight.style.display='block';
        document.querySelector('.bg-flash').style.animation = 'bgFlash 1.5s ease-in-out infinite';
        bgFlashIntense.style.display = 'block';
        
        // æ´—ç‰Œæ—¶éšè—å¡”ç½—ç‰Œç¬¦å·
        tarotSymbolsContainer.style.opacity = '0.05';
    }

    function endRitualFocus() {
        ritualLight.style.display='none';
        document.querySelector('.bg-flash').style.animation = 'bgFlash 4s ease-in-out infinite';
        bgFlashIntense.style.display = 'none';
        
        // æ´—ç‰Œå®Œæˆåæ¢å¤å¡”ç½—ç‰Œç¬¦å·
        tarotSymbolsContainer.style.opacity = '1';
    }

    // æ´—ç‰Œå‡½æ•° - éšæœºæ‰“ä¹±ç‰Œç»„
    function shuffleDeck(cardArray) {
        const shuffled = [...cardArray];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    function initializeDeck(){
        // æ¸…ç©ºåŠ¨ç”»åŒºåŸŸ
        animationArea.innerHTML='<div id="tarotSymbolsContainer" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:1;"></div><div class="ritual-light" id="ritualLight"></div><div id="particlesContainer" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:30;"></div>';
        particlesContainer = document.getElementById('particlesContainer');
        tarotSymbolsContainer = document.getElementById('tarotSymbolsContainer');
        ritualLight = document.getElementById('ritualLight');
        ritualLight.style.display='none';
        
        // åˆ›å»ºå¡”ç½—ç‰Œç¬¦å·èƒŒæ™¯
        createTarotSymbols();
        
        cards=[];
        const areaWidth=animationArea.offsetWidth;
        const areaHeight=animationArea.offsetHeight;
        
        // æ´—ç‰Œ
        const shuffledCards = shuffleDeck([...tarotCards]);
        
        for(let i=0;i<shuffledCards.length;i++){
            const cardData=shuffledCards[i];
            const card=document.createElement('div');
            card.className='card';
            card.dataset.id=i;
            card.dataset.cardName=cardData.name;
            card.innerHTML=`
                <div class="card-front">
                    <img src="${cardData.img}" alt="${cardData.name}" class="card-image" onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\\'card-symbol\\'>âœ¦</div><div class=\\'card-name\\'>${cardData.name}</div>';">
                </div>
                <div class="card-back">
                    <img src="${backImagePath}" alt="ç‰ŒèƒŒ" class="back-image" onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\\'mystic-symbol\\'>âœ¦</div><div>å¡”ç½—ç‰Œ</div>';">
                </div>
            `;
            card.style.left=`${(areaWidth-140)/2}px`;
            card.style.top=`${(areaHeight-220)/2}px`;
            card.style.zIndex = 20 + i;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ - ç¿»è½¬ç‰Œ
            card.addEventListener('click', function() {
                handleCardClick(this);
            });
            
            animationArea.appendChild(card);
            cards.push(card);
        }
        statusMessage.textContent='ç‰Œå·²å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…æ´—ç‰Œå¼€å§‹...';
        
        // é‡ç½®å åœçŠ¶æ€
        flippedCount = 0;
        selectedCards = [];
        
        // é‡ç½®æŒ‰é’®çŠ¶æ€
        startShuffleBtn.style.display = 'block';
        startShuffleBtn.disabled = false;
        startShuffleBtn.textContent = 'å¼€å§‹æ´—ç‰Œ';
        startDivinationBtn.style.display = 'none';
        resetBtn.style.display = 'none';
    }

    // å¤„ç†ç‰Œç‚¹å‡»äº‹ä»¶
    function handleCardClick(cardElement) {
        // å¦‚æœåœ¨å åœæ¨¡å¼ä¸”å·²è¾¾åˆ°æœ€å¤§ç¿»ç‰Œæ•°ï¼Œåˆ™ä¸å…è®¸å†ç¿»ç‰Œ
        if (startDivinationBtn.style.display === 'block' && flippedCount >= MAX_FLIPS && !cardElement.classList.contains('flipped')) {
            statusMessage.textContent = `æ‚¨å·²ç»é€‰æ‹©äº† ${MAX_FLIPS} å¼ ç‰Œï¼Œè¯·ç‚¹å‡»"å¼€å§‹å åœ"è¿›è¡Œè§£è¯»`;
            return;
        }
        
        if (!cardElement.classList.contains('flipped')) {
            // è®¡ç®—ç‰Œå †ä¸Šæ–¹50%çš„ä½ç½®
            const areaHeight = animationArea.offsetHeight;
            const topPosition = areaHeight * 0.5 - 220; // ç‰Œå †ä¸Šæ–¹50%ä½ç½®
            
            cardElement.style.top = `${topPosition}px`;
            cardElement.style.zIndex = 1000; // ç¡®ä¿åœ¨æœ€ä¸Šå±‚
            
            // è®°å½•é€‰ä¸­çš„ç‰Œ
            if (startDivinationBtn.style.display === 'block') {
                flippedCount++;
                const cardName = cardElement.dataset.cardName;
                const cardData = tarotCards.find(card => card.name === cardName);
                if (cardData) {
                    selectedCards.push({
                        ...cardData,
                        position: flippedCount // è®°å½•ä½ç½®ï¼š1-è¿‡å»ï¼Œ2-ç°åœ¨ï¼Œ3-æœªæ¥
                    });
                }
                
                statusMessage.textContent = `å·²é€‰æ‹© ${flippedCount}/${MAX_FLIPS} å¼ ç‰Œ`;
                
                // å¦‚æœå·²é€‰ä¸‰å¼ ç‰Œï¼Œæç¤ºç”¨æˆ·å¯ä»¥å¼€å§‹å åœ
                if (flippedCount === MAX_FLIPS) {
                    statusMessage.textContent = `å·²é€‰æ‹© ${MAX_FLIPS} å¼ ç‰Œï¼Œè¯·ç‚¹å‡»"å¼€å§‹å åœ"è¿›è¡Œè§£è¯»`;
                }
            }
        }
        cardElement.classList.toggle('flipped');
    }

    function completeShuffle() {
        statusMessage.textContent='â­ æ´—ç‰Œå®Œæˆï¼è¯·é€‰æ‹©æ‚¨è¦æŠ½å–çš„ç‰Œ...';
        
        const areaWidth=animationArea.offsetWidth;
        const areaHeight=animationArea.offsetHeight;
        const centerLeft=(areaWidth-140)/2;
        const centerTop=(areaHeight-220)/2;
        createParticles(centerLeft+70, centerTop+110, 50, true);
        
        setTimeout(() => {
            endRitualFocus();
            animationArea.innerHTML='<div id="tarotSymbolsContainer" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:1;"></div><div class="ritual-light" id="ritualLight"></div><div id="particlesContainer" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:30;"></div>';
            particlesContainer = document.getElementById('particlesContainer');
            tarotSymbolsContainer = document.getElementById('tarotSymbolsContainer');
            ritualLight = document.getElementById('ritualLight');
            ritualLight.style.display='none';
            
            // é‡æ–°åˆ›å»ºå¡”ç½—ç‰Œç¬¦å·
            createTarotSymbols();
            
            const cardTrack=document.createElement('div');
            cardTrack.className='card-track';
            animationArea.appendChild(cardTrack);
            
            // åˆ›å»ºå”¯ä¸€çš„ç‰Œç»„ - ä¿®å¤é‡å¤ç‰Œçš„é—®é¢˜
            const uniqueCards = shuffleDeck([...tarotCards]);
            
            // åªåˆ›å»ºä¸€å¥—ç‰Œï¼Œé¿å…é‡å¤
            uniqueCards.forEach((cardData, index)=>{
                const trackCard=document.createElement('div');
                trackCard.className='track-card';
                trackCard.dataset.cardName = cardData.name;
                trackCard.dataset.uniqueId = index; // æ·»åŠ å”¯ä¸€æ ‡è¯†
                trackCard.innerHTML=`
                    <div class="card-front">
                        <img src="${cardData.img}" alt="${cardData.name}" class="card-image" onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\\'card-symbol\\'>âœ¦</div><div class=\\'card-name\\'>${cardData.name}</div>';">
                    </div>
                    <div class="card-back">
                        <img src="${backImagePath}" alt="ç‰ŒèƒŒ" class="back-image" onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\\'mystic-symbol\\'>âœ¦</div><div>å¡”ç½—ç‰Œ</div>';">
                    </div>
                `;
                trackCard.addEventListener('click', function() {
                    handleCardClick(this);
                });
                cardTrack.appendChild(trackCard);
            });
            
            isAnimating=false;
            
            startShuffleBtn.style.display = 'none';
            startDivinationBtn.style.display = 'block';
            resetBtn.style.display = 'block';
            resetBtn.disabled = false;
            
            // é‡ç½®å åœçŠ¶æ€
            flippedCount = 0;
            selectedCards = [];
            statusMessage.textContent = `è¯·é€‰æ‹© ${MAX_FLIPS} å¼ ç‰Œè¿›è¡Œå åœ (0/${MAX_FLIPS})`;
        }, 1200);
    }

    // å¼€å§‹å åœå‡½æ•° - è·³è½¬åˆ°è§£è¯»é¡µé¢
    function startDivination() {
        if (flippedCount < MAX_FLIPS) {
            statusMessage.textContent = `è¯·å…ˆé€‰æ‹© ${MAX_FLIPS} å¼ ç‰Œ`;
            return;
        }
        
        // å°†é€‰ä¸­çš„ç‰Œæ•°æ®ä¿å­˜åˆ°localStorage
        localStorage.setItem('selectedTarotCards', JSON.stringify(selectedCards));
        
        // è·³è½¬åˆ°è§£è¯»é¡µé¢
        window.location.href = 'interpretation.html';
    }

    function shuffleAnimation(){
        if(isAnimating) return;
        isAnimating=true;
        startShuffleBtn.disabled=true;
        
        startRitualFocus();
        statusMessage.textContent='âœ¨ æ´—ç‰Œå¼€å§‹... âœ¨';
        
        const areaWidth=animationArea.offsetWidth;
        const areaHeight=animationArea.offsetHeight;
        const centerLeft=(areaWidth-140)/2;
        const centerTop=(areaHeight-220)/2;

        createParticles(centerLeft+70, centerTop+110, 40, true);

        setTimeout(()=>{
            statusMessage.textContent='ğŸŒ€ èƒ½é‡æ±‡èšä¸­...';
            cards.forEach((card,i)=>{
                setTimeout(()=>{
                    card.style.left=`${Math.random()*(areaWidth-140)}px`;
                    card.style.top=`${Math.random()*(areaHeight-220)}px`;
                    card.style.zIndex = 20 + i;
                    createParticles(
                        parseFloat(card.style.left) + 70, 
                        parseFloat(card.style.top) + 110, 
                        5, 
                        i % 4 === 0
                    );
                },i*30);
            });
        },800);

        setTimeout(()=>{
            statusMessage.textContent='ğŸŒªï¸ å‘½è¿äº¤é”™ä¸­...';
            const half=Math.floor(cards.length/2);
            const leftStack=cards.slice(0,half);
            const rightStack=cards.slice(half);
            
            createParticles(areaWidth*0.25, centerTop+110, 20, true);
            createParticles(areaWidth*0.65, centerTop+110, 20, true);
            
            leftStack.forEach((card,i)=>{ 
                setTimeout(()=>{ 
                    card.style.left=`${areaWidth*0.25}px`; 
                    card.style.top=`${centerTop}px`; 
                    card.style.zIndex = 20 + i;
                    createParticles(areaWidth*0.25, centerTop+110, 3);
                }, i*40); 
            });
            
            rightStack.forEach((card,i)=>{ 
                setTimeout(()=>{ 
                    card.style.left=`${areaWidth*0.65}px`; 
                    card.style.top=`${centerTop}px`; 
                    card.style.zIndex = 20 + half + i;
                    createParticles(areaWidth*0.65, centerTop+110, 3);
                }, i*40); 
            });
            
            setTimeout(()=>{
                cards.forEach((card,i)=>{ 
                    setTimeout(()=>{ 
                        card.style.left=`${centerLeft}px`; 
                        card.style.top=`${centerTop}px`; 
                        card.style.zIndex = 20 + i;
                        createParticles(centerLeft+70, centerTop+110, 3, i > cards.length - 5);
                    }, i*50); 
                });
            },Math.max(leftStack.length,rightStack.length)*40+400);
        },cards.length*30+1500);

        setTimeout(()=>{
            statusMessage.textContent='ğŸ”® å‘½è¿ä¹‹è½®è½¬åŠ¨...';
            const third=Math.floor(cards.length/3);
            const part1=cards.slice(0,third),
                  part2=cards.slice(third,third*2),
                  part3=cards.slice(third*2);
            
            createParticles(areaWidth*0.25, centerTop+110, 15, true);
            createParticles(areaWidth*0.45, centerTop+110, 15, true);
            createParticles(areaWidth*0.65, centerTop+110, 15, true);
            
            part1.forEach((c,i)=>{ 
                setTimeout(()=>{ 
                    c.style.left=`${areaWidth*0.25}px`; 
                    c.style.top=`${centerTop}px`; 
                    c.style.zIndex = 20 + i;
                    createParticles(areaWidth*0.25, centerTop+110, 2);
                }, i*50); 
            });
            
            part2.forEach((c,i)=>{ 
                setTimeout(()=>{ 
                    c.style.left=`${areaWidth*0.45}px`; 
                    c.style.top=`${centerTop}px`; 
                    c.style.zIndex = 20 + third + i;
                    createParticles(areaWidth*0.45, centerTop+110, 2);
                }, i*50); 
            });
            
            part3.forEach((c,i)=>{ 
                setTimeout(()=>{ 
                    c.style.left=`${areaWidth*0.65}px`; 
                    c.style.top=`${centerTop}px`; 
                    c.style.zIndex = 20 + third*2 + i;
                    createParticles(areaWidth*0.65, centerTop+110, 2);
                }, i*50); 
            });
            
            setTimeout(()=>{
                cards.forEach((c,i)=>{ 
                    setTimeout(()=>{ 
                        c.style.left=`${centerLeft}px`; 
                        c.style.top=`${centerTop}px`; 
                        c.style.zIndex = 20 + i;
                        createParticles(centerLeft+70, centerTop+110, 3, i > cards.length - 8);
                    }, i*60); 
                });
            },Math.max(part1.length,part2.length,part3.length)*50+600);
        },cards.length*50+3000);

        setTimeout(completeShuffle, cards.length*60+4500);
    }

    function resetShuffle() {
        loadTarotData();
    }

    // åˆå§‹åŒ–
    startShuffleBtn.addEventListener('click', shuffleAnimation);
    startDivinationBtn.addEventListener('click', startDivination);
    resetBtn.addEventListener('click', resetShuffle);
    
    // åŠ è½½å¡”ç½—ç‰Œæ•°æ®
    loadTarotData();
});
</script>
</body>
</html>